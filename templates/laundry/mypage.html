{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* 기존 스타일 그대로 유지 */
.mypage-container {
    width: 500px;
    margin: 40px 0 0 40px;
    padding: 2.5rem 2rem;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-family: '맑은 고딕', sans-serif;
}
.mypage-section li {
    margin: 12px 0;
    font-size: 1rem;
}
.timer {
    font-size: 0.9rem;
    color: #c00;
    margin-left: 10px;
}
.confirm-btn {
    background-color: #003366;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 5px 10px;
    margin-left: 10px;
    cursor: pointer;
}
</style>

<div class="mypage-container">
    <div class="mypage-header">
        <img src="{% static '상징_미네르바_배경흰색.png' %}" alt="학교 로고">
        <div class="info">
            <h2>{{ user.last_name }}{{ user.first_name }}</h2>
            <p>{{ user.profile.student_id }} || {{ user.profile.department }}</p>
            <p>{{ user.email }}</p>
        </div>
    </div>

    <div class="mypage-section">
        <p>현재 로그인한 사용자: {{ user.student_id }}</p>
        <h3>▼ 내 예약 관리</h3>
        <ul id="reservation-list">
            {% for res in reservations %}
                <li>
                    {{ res.machine.building }}동 {{ res.machine.name }}
                    {% if not res.confirmed %}
                        <span class="timer" id="timer-{{ res.id }}">--:--</span>
                        <button class="confirm-btn" onclick="confirmReservation({{ res.id }})">사용 시작</button>
                    {% else %}
                        ✅ 사용 중
                    {% endif %}
                </li>
            {% empty %}
                <li>예약 내역이 없습니다.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="mypage-section">
        <h3>▼ 내 계정 관리</h3>
        <ul>
            <li><a href="#">비밀번호 변경</a></li>
        </ul>
    </div>
</div>

<script>
  const reservations = [
    {% for res in reservations %}
      {% if not res.confirmed %}
        { id: {{ res.id }}, created: "{{ res.created_at|date:"Y-m-d H:i:s" }}" },
      {% endif %}
    {% endfor %}
  ];

  function updateTimers() {
    const now = new Date();

    reservations.forEach(r => {
      const createdAt = new Date(r.created.replace(' ', 'T'));
      const diff = 10 * 60 * 1000 - (now - createdAt); // 10분 - 경과시간

      const el = document.getElementById(`timer-${r.id}`);
      if (diff > 0) {
        const min = Math.floor(diff / 60000);
        const sec = Math.floor((diff % 60000) / 1000);
        el.textContent = `남은 시간: ${min}분 ${sec < 10 ? '0' + sec : sec}초`;
      } else {
        el.textContent = "⏰ 만료됨";
      }
    });
  }

  setInterval(updateTimers, 1000);

  function confirmReservation(reservationId) {
    fetch(`/laundry/reservations/confirm/${reservationId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      credentials: 'include',
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      location.reload();
    });
  }
</script>
{% endblock %}

